FROM shib_base

ENV KEYS=/var/shib-keys \
    USR=shibd

RUN yum -y install \
     cronie \
     ca-certificates \
     && yum clean all \
     && rm -rf /var/cache/yum

COPY get-sealer-keys/get-sealer-keys entrypoint-cron.sh /usr/local/bin/
RUN mkdir 700 ${KEYS} && chown ${USR}:${USR} ${KEYS} && chmod g+s ${KEYS} && \
    sed -i -e 's~^\(session.*pam_loginuid.so\)$~#\1~' /etc/pam.d/crond && \
    usermod -a -G tty shibd

VOLUME ["${KEYS}"]

ENTRYPOINT ["/usr/local/bin/entrypoint-cron.sh"]
